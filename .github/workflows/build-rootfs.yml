name: Build ARM RootFS

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.release_meta.outputs.tag_name }}
      release_name: ${{ steps.release_meta.outputs.release_name }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Compute release metadata
        id: release_meta
        run: |
          set -euo pipefail
          current_time=$(date +"%y.%U.%H.%M")
          echo "tag_name=rootfs-release-${current_time}" >> "$GITHUB_OUTPUT"
          echo "release_name=RootFS Release ${current_time}" >> "$GITHUB_OUTPUT"

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_meta.outputs.tag_name }}
          release_name: ${{ steps.release_meta.outputs.release_name }}
          draft: false
          prerelease: true

  build:
    needs: prepare-release
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: write
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-24.04
            runner: ubuntu-24.04-arm
            distro: noble
            arch: arm64
            mirror: http://ports.ubuntu.com/ubuntu-ports
            hostname: noble
            chunk_size: 1500m
            default_user_name: gamer
            default_user_password: passwd
            desktop_env: ubuntu-desktop
            tz_region: Asia/Shanghai
            kernel_repo: sunflower2333/linux
            firmware_repo: sunflower2333/linux-firmware-ayaneo
            hangover_url: https://github.com/AndreRH/hangover/releases/download/hangover-10.14/hangover_10.14_ubuntu2404_noble_arm64.tar
            apt_sources: ""
            container_packages: |
              ubuntu-minimal
              systemd
              dbus
              locales
              tzdata
              ca-certificates
              gnupg
              wget
              curl
              network-manager
              flatpak
              gcc
              python3
              python3-pip
              linux-firmware
              zip
              unzip
              p7zip-full
              zstd
              nano
              vim
              mesa-utils
              vulkan-tools
              __DESKTOP_ENV__
              systemsettings
              xinput
              firefox
              firefox-l10n-zh-cn
              language-pack-zh-hans
              language-pack-gnome-zh-hans
              unrar

          - name: debian-13
            runner: ubuntu-24.04-arm
            distro: trixie
            arch: arm64
            mirror: http://deb.debian.org/debian
            hostname: trixie
            chunk_size: 1500m
            default_user_name: gamer
            default_user_password: passwd
            desktop_env: task-kde-desktop
            tz_region: Asia/Shanghai
            kernel_repo: sunflower2333/linux
            firmware_repo: sunflower2333/linux-firmware-ayaneo
            hangover_url: https://github.com/AndreRH/hangover/releases/download/hangover-10.14/hangover_10.14_debian13_trixie_arm64.tar
            apt_sources: |
              deb http://deb.debian.org/debian trixie main contrib non-free non-free-firmware
              deb http://deb.debian.org/debian trixie-updates main contrib non-free non-free-firmware
              deb http://deb.debian.org/debian trixie-backports main contrib non-free non-free-firmware
              deb http://deb.debian.org/debian-security trixie-security main contrib non-free non-free-firmware
            container_packages: |
              systemd
              systemd-sysv
              dbus
              locales
              tzdata
              ca-certificates
              gnupg
              wget
              curl
              network-manager
              flatpak
              gcc
              python3
              python3-pip
              firmware-linux
              firmware-linux-free
              firmware-linux-nonfree
              firmware-qcom-media
              firmware-qcom-soc
              firmware-atheros
              qcom-phone-utils
              zip
              unzip
              unrar
              p7zip-full
              zstd
              nano
              vim
              mesa-utils
              vulkan-tools
              __DESKTOP_ENV__
              sddm
              plasma-workspace
              maliit-keyboard
              breeze
              systemsettings
              xinput
              firefox-esr
              kde-config-sddm
    env:
      DISTRO: ${{ matrix.distro }}
      ARCH: ${{ matrix.arch }}
      OUTPUT_PREFIX: ${{ format('{0}-{1}', matrix.name, matrix.arch) }}
      MIRROR: ${{ matrix.mirror }}
      CHUNK_SIZE: ${{ matrix.chunk_size }}
      HOSTNAME_NAME: ${{ matrix.hostname }}
      DEFAULT_USER_NAME: ${{ matrix.default_user_name }}
      DEFAULT_USER_PASSWORD: ${{ matrix.default_user_password }}
      DESKTOP_ENV: ${{ matrix.desktop_env }}
      TZ_REGION: ${{ matrix.tz_region }}
      KERNEL_PACKS_REPO: ${{ matrix.kernel_repo }}
      FW_PACKS_REPO: ${{ matrix.firmware_repo }}
      HANGOVER_URL: ${{ matrix.hangover_url }}
      CONTAINER_PACKAGES: ${{ matrix.container_packages }}
      APT_SOURCES_LIST: ${{ matrix.apt_sources }}
      MATRIX_NAME: ${{ matrix.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap lxc jq p7zip-full zstd curl wget ca-certificates \
            e2fsprogs \
            tar xz-utils gnupg dnsmasq-base uidmap

      - name: Run LXC build script
        env:
          SUDO_ENV_VARS: OUTPUT_PREFIX DISTRO ARCH MIRROR CHUNK_SIZE HOSTNAME_NAME DEFAULT_USER_NAME DEFAULT_USER_PASSWORD DESKTOP_ENV TZ_REGION KERNEL_PACKS_REPO FW_PACKS_REPO HANGOVER_URL CONTAINER_PACKAGES APT_SOURCES_LIST
        run: |
          set -euo pipefail
          chmod +x build_ubuntu.sh

          sudo_env_vars="${SUDO_ENV_VARS:-OUTPUT_PREFIX DISTRO ARCH MIRROR CHUNK_SIZE HOSTNAME_NAME DEFAULT_USER_NAME DEFAULT_USER_PASSWORD DESKTOP_ENV TZ_REGION KERNEL_PACKS_REPO FW_PACKS_REPO HANGOVER_URL CONTAINER_PACKAGES APT_SOURCES_LIST}"
          preserve_list="PATH"
          for var_name in ${sudo_env_vars}; do
            preserve_list="${preserve_list},${var_name}"
          done

          sudo --preserve-env="${preserve_list}" ./build_ubuntu.sh

      - name: Upload rootfs artifacts to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.prepare-release.outputs.tag_name }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          parts=( ${OUTPUT_PREFIX}-rootfs.7z.* )
          if (( ${#parts[@]} == 0 )); then
            echo "No 7z split parts found to upload (expected pattern: ${OUTPUT_PREFIX}-rootfs.7z.*)." >&2
            ls -al
            exit 1
          fi

          echo "Found ${#parts[@]} split 7z parts: ${parts[*]}"
          echo "Uploading to release tag: ${RELEASE_TAG}"

          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI not found, installing..."
            sudo apt-get update && sudo apt-get install -y gh
          fi

          gh release upload "${RELEASE_TAG}" "${parts[@]}" --clobber
          echo "All 7z parts uploaded via gh CLI."

  build-esp:
    needs: prepare-release
    uses: ./.github/workflows/build-esp-image.yml
    secrets: inherit
    with:
      release_tag: ${{ needs.prepare-release.outputs.tag_name }}
      esp_partition_size: 8388608
      root_partition_uuid: 72BC016E-4127-21F1-4961-1DD827D7D325
      root_partition_partlabel: rawdump
      sd_root_uuid: 49C40B22-A4DD-44FC-A00D-79DB6C6640C6
      sd_root_partlabel: rootfs

  build-sd:
    name: Build SD image
    needs:
      - prepare-release
      - build
      - build-esp
    strategy:
      fail-fast: false
      matrix:
        include:
          - distribution_name: ubuntu-24.04
            rootfs_prefix: ubuntu-24.04-arm64
            sd_root_uuid: 49C40B22-A4DD-44FC-A00D-79DB6C6640C6
            sd_root_partlabel: rootfs
            chunk_size: 1500m
          - distribution_name: debian-13
            rootfs_prefix: debian-13-arm64
            sd_root_uuid: 49C40B22-A4DD-44FC-A00D-79DB6C6640C6
            sd_root_partlabel: rootfs
            chunk_size: 1500m
    uses: ./.github/workflows/build-sd-image.yml
    secrets: inherit
    with:
      release_tag: ${{ needs.prepare-release.outputs.tag_name }}
      distribution_name: ${{ matrix.distribution_name }}
      rootfs_prefix: ${{ matrix.rootfs_prefix }}
      sd_root_uuid: ${{ matrix.sd_root_uuid }}
      sd_root_partlabel: ${{ matrix.sd_root_partlabel }}
      chunk_size: ${{ matrix.chunk_size }}

  cleanup-release:
    name: Release Cleanup on Failure
    if: ${{ failure() || cancelled() }}
    needs:
      - prepare-release
      - build
      - build-esp
      - build-sd
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - name: Delete release and tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.prepare-release.outputs.tag_name }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [[ -z "${RELEASE_TAG}" ]]; then
            echo "No release tag from prepare job; skipping cleanup."
            exit 0
          fi

          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

          echo "Deleting release ${RELEASE_TAG}"
          gh release delete "${RELEASE_TAG}" --repo "${REPO}" --yes --cleanup-tag || echo "Release or tag not found, nothing to delete."
