name: Build ESP Image

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
      esp_partition_size:
        required: true
        type: number
      root_partition_uuid:
        required: true
        type: string
      root_partition_partlabel:
        required: true
        type: string
      sd_root_uuid:
        required: true
        type: string
      sd_root_partlabel:
        required: true
        type: string
      output_suffix:
        required: false
        type: string
        default: ""

jobs:
  build-esp:
    name: Build and upload ESP image
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dosfstools p7zip-full curl wget unzip

      - name: Run ESP build script
        run: |
          chmod +x ./build_esp.sh
          ./build_esp.sh \
            ${{ inputs.esp_partition_size }} \
            ${{ inputs.root_partition_uuid }} \
            ${{ inputs.root_partition_partlabel }} \
            ${{ inputs.sd_root_uuid }} \
            ${{ inputs.sd_root_partlabel }}

      - name: Upload ESP image to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          release_tag="${{ inputs.release_tag }}"
          suffix="${{ inputs.output_suffix }}"
          img="ESP/esp.img.7z"

          if [[ ! -f "${img}" ]]; then
            echo "Expected image ${img} not found" >&2
            ls -al ESP || true
            exit 1
          fi

          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          fi

          # Rename with suffix if provided
          if [[ -n "${suffix}" ]]; then
            mv "${img}" "ESP/esp${suffix}.img.7z"
            img="ESP/esp${suffix}.img.7z"
          fi

          echo "Uploading ${img} to release ${release_tag}"
          gh release upload "${release_tag}" "${img}" --clobber
